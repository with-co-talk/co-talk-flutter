name: Build & Deploy iOS

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      skip_upload:
        description: 'Skip TestFlight upload (build only)'
        required: false
        default: false
        type: boolean
      environment:
        description: 'Build environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod

env:
  FLUTTER_VERSION: '3.32.2'

concurrency:
  group: build-ios-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # 1단계: 테스트
  # ===========================================
  test:
    name: Test & Analyze
    uses: ./.github/workflows/test.yml

  # ===========================================
  # 2단계: iOS 빌드 + TestFlight 업로드
  # ===========================================
  build-ios:
    name: Build iOS & Upload to TestFlight
    needs: test
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      HAS_IOS_SIGNING: ${{ secrets.IOS_CERTIFICATE_BASE64 != '' }}
      HAS_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 != '' }}
      HAS_FIREBASE: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST_BASE64 != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install dependencies
        run: flutter pub get

      # Apple 인증서 및 프로비저닝 프로필 설정
      - name: Install Apple certificate and provisioning profile
        if: env.HAS_IOS_SIGNING == 'true'
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate and provisioning profile from secrets
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Apply provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

      # App Store Connect API Key 설정
      - name: Set up App Store Connect API Key
        if: env.HAS_API_KEY == 'true'
        run: |
          mkdir -p fastlane/keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > fastlane/keys/AuthKey.p8

      # Firebase GoogleService-Info.plist 설정
      - name: Set up Firebase
        if: env.HAS_FIREBASE == 'true'
        run: |
          echo "${{ secrets.GOOGLE_SERVICE_INFO_PLIST_BASE64 }}" | base64 --decode > ios/Runner/GoogleService-Info.plist

      # CocoaPods 캐시
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-${{ runner.arch }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: ${{ runner.os }}-${{ runner.arch }}-pods-

      - name: Install CocoaPods
        run: cd ios && pod install --repo-update

      # 환경 결정
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=prod" >> $GITHUB_OUTPUT
          fi

      # Flutter IPA 빌드
      - name: Build IPA
        run: |
          flutter build ipa \
            --release \
            --build-number=${{ github.run_number }} \
            --dart-define=ENVIRONMENT=${{ steps.env.outputs.environment }} \
            --export-options-plist=ios/ExportOptions.plist

      # 버전 정보 추출
      - name: Get version
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # IPA Artifact 업로드
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: CoTalk-iOS-v${{ steps.version.outputs.version }}-${{ github.run_number }}
          path: build/ios/ipa/*.ipa
          retention-days: 30

      # TestFlight 업로드 (Fastlane)
      - name: Upload to TestFlight
        if: |
          env.HAS_API_KEY == 'true' &&
          (github.event_name == 'push' || inputs.skip_upload != true)
        env:
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY_FILEPATH: ${{ github.workspace }}/fastlane/keys/AuthKey.p8
        run: |
          bundle exec fastlane upload_ios

      # 키체인 정리
      - name: Clean up keychain
        if: ${{ always() }}
        run: |
          if [ -f "$RUNNER_TEMP/app-signing.keychain-db" ]; then
            security delete-keychain $RUNNER_TEMP/app-signing.keychain-db
          fi

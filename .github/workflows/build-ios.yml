name: Build & Deploy iOS

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      skip_upload:
        description: 'Skip TestFlight upload (build only)'
        required: false
        default: false
        type: boolean
      environment:
        description: 'Build environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod

env:
  FLUTTER_VERSION: '3.32.2'

concurrency:
  group: build-ios-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # 1단계: 테스트
  # ===========================================
  test:
    name: Test & Analyze
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run analyzer
        run: flutter analyze --no-fatal-infos

      - name: Run tests
        run: flutter test

  # ===========================================
  # 2단계: iOS 빌드 + TestFlight 업로드
  # ===========================================
  build-ios:
    name: Build iOS & Upload to TestFlight
    needs: test
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Add Bundler platforms
        run: bundle lock --add-platform arm64-darwin x86_64-linux

      - name: Install dependencies
        run: flutter pub get

      # App Store Connect API Key 설정 (Secret이 설정된 경우에만)
      - name: Set up App Store Connect API Key
        if: env.APP_STORE_CONNECT_API_KEY_BASE64 != ''
        env:
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          mkdir -p fastlane/keys
          echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > fastlane/keys/AuthKey.p8

      # CocoaPods 캐시
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: ${{ runner.os }}-pods-

      - name: Install CocoaPods
        run: cd ios && pod install --repo-update

      # iOS 코드 서명: 시크릿 검증 후 인증서/프로비저닝 프로파일 설치 (IPA 빌드에 필수)
      - name: Validate iOS code signing secrets
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          if [ -z "$BUILD_CERTIFICATE_BASE64" ] || [ -z "$P12_PASSWORD" ] || [ -z "$BUILD_PROVISION_PROFILE_BASE64" ] || [ -z "$KEYCHAIN_PASSWORD" ]; then
            echo "::error::iOS IPA build requires repository secrets: BUILD_CERTIFICATE_BASE64, P12_PASSWORD, BUILD_PROVISION_PROFILE_BASE64, KEYCHAIN_PASSWORD"
            echo "Export .p12 (distribution cert) and .mobileprovision (App Store profile) from Xcode/Apple Developer, then add as base64 + passwords in repo Secrets."
            exit 1
          fi

      - name: Import signing certificate and provisioning profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode > cert.p12
          security import cert.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      # 환경 결정
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=prod" >> $GITHUB_OUTPUT
          fi

      # Flutter IPA 빌드
      - name: Build IPA
        run: |
          flutter build ipa \
            --release \
            --dart-define=ENVIRONMENT=${{ steps.env.outputs.environment }} \
            --export-options-plist=ios/ExportOptions.plist

      # 버전 정보 추출
      - name: Get version
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # IPA Artifact 업로드
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: CoTalk-iOS-v${{ steps.version.outputs.version }}
          path: build/ios/ipa/*.ipa
          retention-days: 30

      # TestFlight 업로드 (Fastlane) - Secret 설정 + skip_upload 아닌 경우만
      - name: Upload to TestFlight
        if: inputs.skip_upload != true && env.APP_STORE_CONNECT_API_KEY_KEY_ID != ''
        env:
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY_FILEPATH: ./fastlane/keys/AuthKey.p8
        run: |
          cd fastlane && bundle exec fastlane upload_ios

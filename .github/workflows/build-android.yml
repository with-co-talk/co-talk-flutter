name: Build & Deploy Android

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      skip_upload:
        description: 'Skip Google Play upload (build only)'
        required: false
        default: false
        type: boolean
      track:
        description: 'Google Play track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      build_type:
        description: 'Build type'
        required: true
        default: 'appbundle'
        type: choice
        options:
          - appbundle
          - apk
      environment:
        description: 'Build environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod

env:
  FLUTTER_VERSION: '3.32.2'
  JAVA_VERSION: '17'

concurrency:
  group: build-android-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # 1단계: 테스트
  # ===========================================
  test:
    name: Test & Analyze
    uses: ./.github/workflows/test.yml

  # ===========================================
  # 2단계: Android 빌드 + Google Play 업로드
  # ===========================================
  build-android:
    name: Build Android & Upload to Google Play
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      HAS_ANDROID_SIGNING: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
      HAS_GOOGLE_SERVICES: ${{ secrets.GOOGLE_SERVICES_JSON != '' }}
      HAS_PLAY_STORE_KEY: ${{ secrets.PLAY_STORE_KEY_JSON != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      # Android 서명 키 설정
      - name: Set up Android signing
        if: env.HAS_ANDROID_SIGNING == 'true'
        run: |
          mkdir -p android/keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/keystore/co-talk-release.jks
          cat <<'PROPS' > android/key.properties
          storePassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=co-talk
          storeFile=../keystore/co-talk-release.jks
          PROPS
          sed -i 's/^ *//' android/key.properties

      # Firebase google-services.json 설정
      - name: Set up Firebase
        if: env.HAS_GOOGLE_SERVICES == 'true'
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" > android/app/google-services.json

      # 환경 결정
      - name: Determine build config
        id: config
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "build_type=${{ inputs.build_type }}" >> $GITHUB_OUTPUT
            echo "track=${{ inputs.track }}" >> $GITHUB_OUTPUT
          else
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "build_type=appbundle" >> $GITHUB_OUTPUT
            echo "track=internal" >> $GITHUB_OUTPUT
          fi

      # Gradle 캐시
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      # AAB 빌드
      - name: Build App Bundle
        if: steps.config.outputs.build_type == 'appbundle'
        run: |
          flutter build appbundle \
            --release \
            --build-number=${{ github.run_number }} \
            --dart-define=ENVIRONMENT=${{ steps.config.outputs.environment }}

      # APK 빌드
      - name: Build APK
        if: steps.config.outputs.build_type == 'apk'
        run: |
          flutter build apk \
            --release \
            --build-number=${{ github.run_number }} \
            --dart-define=ENVIRONMENT=${{ steps.config.outputs.environment }}

      # 버전 정보 추출
      - name: Get version
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # AAB Artifact 업로드
      - name: Upload AAB artifact
        if: steps.config.outputs.build_type == 'appbundle'
        uses: actions/upload-artifact@v4
        with:
          name: CoTalk-Android-AAB-v${{ steps.version.outputs.version }}-${{ github.run_number }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      # APK Artifact 업로드
      - name: Upload APK artifact
        if: steps.config.outputs.build_type == 'apk'
        uses: actions/upload-artifact@v4
        with:
          name: CoTalk-Android-APK-v${{ steps.version.outputs.version }}-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      # Google Play 업로드 (Fastlane)
      - name: Set up Ruby
        if: |
          env.HAS_PLAY_STORE_KEY == 'true' &&
          steps.config.outputs.build_type == 'appbundle' &&
          (github.event_name == 'push' || inputs.skip_upload != true)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Set up Google Play credentials
        if: |
          env.HAS_PLAY_STORE_KEY == 'true' &&
          steps.config.outputs.build_type == 'appbundle' &&
          (github.event_name == 'push' || inputs.skip_upload != true)
        run: |
          mkdir -p fastlane/keys
          echo "${{ secrets.PLAY_STORE_KEY_JSON }}" > fastlane/keys/play-store-key.json

      - name: Upload to Google Play
        if: |
          env.HAS_PLAY_STORE_KEY == 'true' &&
          steps.config.outputs.build_type == 'appbundle' &&
          (github.event_name == 'push' || inputs.skip_upload != true)
        run: |
          bundle exec fastlane upload_android track:${{ steps.config.outputs.track }}

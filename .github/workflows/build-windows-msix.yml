name: Build Windows MSIX

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Build environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod
      certificate_sign:
        description: 'Sign with certificate'
        required: false
        default: false
        type: boolean

env:
  FLUTTER_VERSION: '3.32.2'

concurrency:
  group: build-windows-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # 1단계: Flutter 분석 + 테스트
  # ===========================================
  test:
    name: Test & Analyze
    uses: ./.github/workflows/test.yml

  # ===========================================
  # 2단계: Windows MSIX 빌드 (push/dispatch만, PR은 스킵)
  # ===========================================
  build-windows:
    name: Build Windows MSIX
    needs: test
    if: github.event_name != 'pull_request'
    runs-on: windows-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Install dependencies
        run: flutter pub get

      - name: Determine environment
        id: env
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=prod" >> $GITHUB_OUTPUT
          fi

      # 인증서 서명이 필요한 경우 (수동 트리거 + certificate_sign=true)
      - name: Decode certificate
        if: inputs.certificate_sign == true
        shell: powershell
        run: |
          $pfxBytes = [System.Convert]::FromBase64String("${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}")
          [System.IO.File]::WriteAllBytes("${{ github.workspace }}\certificate.pfx", $pfxBytes)

      # MSIX 생성 (인증서 서명 있음)
      - name: Create MSIX (signed)
        if: github.event_name == 'workflow_dispatch' && inputs.certificate_sign == true
        run: >
          dart run msix:create
          --install-certificate false
          --certificate-path "${{ github.workspace }}\certificate.pfx"
          --certificate-password "${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}"
          --build-windows false
          --windows-build-args "--dart-define=ENVIRONMENT=${{ steps.env.outputs.environment }} --build-number=${{ github.run_number }}"

      # Windows 빌드 + MSIX 생성 (자체 서명 - 기본)
      - name: Create MSIX (self-signed)
        if: github.event_name != 'workflow_dispatch' || inputs.certificate_sign != true
        run: >
          dart run msix:create
          --install-certificate false
          --windows-build-args "--dart-define=ENVIRONMENT=${{ steps.env.outputs.environment }} --build-number=${{ github.run_number }}"

      # MSIX 파일 생성 확인
      - name: Verify MSIX file exists
        shell: powershell
        run: |
          $msixPath = "build/windows/x64/runner/Release/CoTalk.msix"
          if (-not (Test-Path $msixPath)) {
            Write-Error "MSIX file not found: $msixPath"
            exit 1
          }
          Write-Host "MSIX file verified: $msixPath"

      - name: Get version
        id: version
        shell: bash
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 배포 패키지 생성 (MSIX + 설치 스크립트)
      - name: Create distribution package
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $distDir = "dist/CoTalk-Windows"
          New-Item -ItemType Directory -Path $distDir -Force | Out-Null
          
          # MSIX 파일 복사
          $msixPath = "build/windows/x64/runner/Release/CoTalk.msix"
          if (-not (Test-Path $msixPath)) {
            Write-Error "MSIX file not found: $msixPath"
            exit 1
          }
          Copy-Item $msixPath -Destination $distDir
          Write-Host "MSIX copied"
          
          # Installer scripts (use Get-ChildItem to avoid encoding issues with non-ASCII filenames)
          $installerDir = "installer"
          Copy-Item -LiteralPath (Join-Path $installerDir "install.ps1") -Destination $distDir
          Write-Host "Installer script copied: install.ps1"
          Get-ChildItem -Path $installerDir -Filter "*.bat" -File | ForEach-Object {
            Copy-Item -LiteralPath $_.FullName -Destination $distDir
            Write-Host "Installer script copied: $($_.Name)"
          }
          
          # README (ASCII only to avoid runner encoding issues)
          $readme = @"
          # Co-Talk v${{ steps.version.outputs.version }} - Windows Install Guide
          
          ## How to install
          
          1. Double-click the installation .bat file in this folder.
          2. Click 'Yes' when prompted for administrator permission.
          3. After installation, search for 'Co-Talk' in the Start menu to run.
          
          ## How to uninstall
          
          1. Double-click the uninstall .bat file in this folder.
          2. Click 'Yes' when prompted for administrator permission.
          
          ## System requirements
          
          - Windows 10 version 1809 (build 17763) or later
          - x64 architecture
          "@
          $readme | Out-File -FilePath "$distDir/README.txt" -Encoding UTF8
          
          # ZIP 압축
          Compress-Archive -Path "$distDir/*" -DestinationPath "dist/CoTalk-Windows-v${{ steps.version.outputs.version }}.zip"

      # 빌드 결과물 업로드
      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: CoTalk-Windows-v${{ steps.version.outputs.version }}
          path: dist/CoTalk-Windows-v${{ steps.version.outputs.version }}.zip
          retention-days: 30

  # ===========================================
  # 3단계: GitHub Release 생성 (main 브랜치 push 시)
  # ===========================================
  release:
    name: Create Release
    needs: build-windows
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: CoTalk-Windows-v${{ steps.version.outputs.version }}
          path: ./release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}-windows-${{ github.run_number }}
          name: Co-Talk Windows v${{ steps.version.outputs.version }} (Build ${{ github.run_number }})
          body: |
            ## Co-Talk Windows Desktop v${{ steps.version.outputs.version }}

            ### Build Info
            - Build Number: ${{ github.run_number }}
            - Commit: ${{ github.sha }}

            ### 설치 방법
            1. `CoTalk-Windows-v${{ steps.version.outputs.version }}.zip` 파일을 다운로드합니다
            2. ZIP 파일 압축을 해제합니다
            3. **`Co-Talk 설치.bat`** 파일을 더블클릭합니다
            4. 관리자 권한 요청 창이 나타나면 '예'를 클릭합니다
            5. 시작 메뉴에서 'Co-Talk'을 검색하여 실행합니다

            ### 포함된 파일
            - `CoTalk.msix` - 앱 패키지
            - `Co-Talk 설치.bat` - 설치 스크립트 (이것만 실행하면 됩니다!)
            - `Co-Talk 제거.bat` - 제거 스크립트
            - `README.txt` - 설치 가이드

            ### 요구 사항
            - Windows 10 버전 1809 이상
            - x64 아키텍처
          files: ./release/CoTalk-Windows-v${{ steps.version.outputs.version }}.zip
          draft: true
          generate_release_notes: true
